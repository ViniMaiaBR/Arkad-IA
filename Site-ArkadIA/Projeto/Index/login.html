<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Login & Cadastro | ARKAD AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            font-family: Inter, system-ui, Segoe UI, Roboto, 'Helvetica Neue', Arial;
            margin: 0;
        }
        
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #000000 0%, #0A2647 50%, #144272 100%);
            position: relative;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 22px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(20, 30, 60, 0.08);
            width: 360px;
            position: relative;
            z-index: 1;
        }
        
        h1 {
            font-size: 18px;
            margin: 0 0 12px;
            color: #fff;
            text-align: center;
        }
        
        label {
            display: block;
            font-size: 13px;
            margin-top: 8px;
            color: #fff;
        }
        
        input[type=text], input[type=email], input[type=password] {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            margin-top: 6px;
            background: rgba(255, 255, 255, 0.95);
            color: #0f172a;
            font-size: 14px;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        input[type=text]:focus, input[type=email]:focus, input[type=password]:focus {
            outline: none;
            border-color: #00B5B8;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 3px rgba(0, 181, 184, 0.1);
        }

        input[type=text]:invalid:not(:placeholder-shown), 
        input[type=email]:invalid:not(:placeholder-shown) {
            border-color: #ef4444;
        }
        
        button {
            margin-top: 12px;
            padding: 12px 20px;
            border-radius: 8px;
            border: 0;
            background: #00B5B8;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            width: 100%;
        }

        button:hover:not(:disabled) {
            background: #009698;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 181, 184, 0.3);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .muted {
            font-size: 13px;
            color: #6b7280;
            margin-top: 8px;
        }
        
        .switch {
            font-size: 13px;
            color: #00B5B8;
            cursor: pointer;
        }
        
        .err {
            color: #ef4444;
            font-size: 13px;
            margin-top: 8px;
            padding: 8px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 6px;
            border-left: 3px solid #ef4444;
        }

        .ok {
            color: #10b981;
            font-size: 13px;
            margin-top: 8px;
            padding: 8px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 6px;
            border-left: 3px solid #10b981;
        }
        
        .actions {
            display: flex;
            gap: 8px;
        }
        
        .flex {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        
        .profile {
            margin-top: 14px;
            padding: 12px;
            border-radius: 8px;
            background: rgba(20, 66, 114, 0.2);
        }
        
        small {
            color: #475569;
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <canvas id="neural-bg"></canvas>
    <button class="back-btn" onclick="window.location.href='index.html'">
        <i class="fas fa-arrow-left"></i> Voltar
    </button>
    
    <div class="card">
        <h1 id="title">Entrar</h1>

        <!-- LOGIN FORM -->
        <form id="login-form">
            <label for="login-email">Email ou usuário</label>
            <input id="login-email" type="text" placeholder="Email" required />

            <label for="login-password">Senha</label>
            <input id="login-password" type="password" placeholder="••••••••" required />

            <div class="flex">
                <input id="remember" type="checkbox" />
                <label for="remember">Lembrar-me</label>
            </div>

            <div class="actions">
                <button type="submit" id="login-submit">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
                <button id="to-register" type="button" style="background:#e6eefc;color:#0f172a; margin-top: 8px;">
                    <i class="fas fa-user-plus"></i> Criar conta
                </button>
            </div>

            <div id="login-msg" class="err" aria-live="polite"></div>
        </form>

        <!-- REGISTER FORM -->
        <form id="register-form" style="display:none">
            <label for="name">Nome</label>
            <input id="name" type="text" placeholder="Seu nome" minlength="2" required />

            <label for="email">Email ou usuário</label>
            <input id="email" type="text" placeholder="Email" required />

            <label for="password">Senha</label>
            <input id="password" type="password" placeholder="mínimo 6 caracteres" minlength="6" required />

            <label for="confirm">Confirme a senha</label>
            <input id="confirm" type="password" placeholder="repita a senha" required />

            <div class="actions">
                <button type="submit" id="register-submit">
                    <i class="fas fa-user-plus"></i> Cadastrar
                </button>
                <button id="to-login" type="button" style="background:#e6eefc;color:#0f172a; margin-top: 8px;">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>

            <div id="reg-msg" class="err" aria-live="polite"></div>
        </form>

        <!-- PROFILE (after login) -->
        <div id="profile" style="display:none" class="profile">
            <div><strong id="p-name"></strong></div>
            <div><small id="p-email"></small></div>
            <div style="margin-top:12px">
                <button id="logout">Sair</button>
                <button id="delete" style="background:#ef4444;margin-left:8px">Excluir conta</button>
            </div>
            <div id="profile-msg" class="muted"></div>
        </div>
    </div>

    <script src="../js/neural-background.js"></script>
    <script src="../js/backend-storage.js"></script>
    <script src="../js/login.js"></script>
    <script>
        // ----- UI ELEMENTOS -----
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const toRegister = document.getElementById('to-register');
        const toLogin = document.getElementById('to-login');
        const title = document.getElementById('title');
        const profile = document.getElementById('profile');
        const pName = document.getElementById('p-name');
        const pEmail = document.getElementById('p-email');
        const loginMsg = document.getElementById('login-msg');
        const regMsg = document.getElementById('reg-msg');
        const profileMsg = document.getElementById('profile-msg');

        // ----- FUNÇÕES DE INTERFACE -----
        function showLogin() {
            title.innerText = 'Entrar';
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            profile.style.display = 'none';
            loginMsg.innerText = '';
            regMsg.innerText = '';
        }

        function showRegister() {
            title.innerText = 'Criar conta';
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            profile.style.display = 'none';
            loginMsg.innerText = '';
            regMsg.innerText = '';
        }

        function showProfile(user) {
            title.innerText = 'Perfil';
            loginForm.style.display = 'none';
            registerForm.style.display = 'none';
            profile.style.display = 'block';
            pName.innerText = user.nome || user.name;
            pEmail.innerText = user.email;
        }

        function redirectToChat() {
            // Redirecionar para o chat após login
            window.location.href = 'chat.html';
        }

        function showMessage(element, message, type) {
            element.innerText = message;
            element.className = type === 'success' ? 'ok' : 'err';
            element.style.display = 'block';
        }

        function hideMessage(element) {
            element.innerText = '';
            element.style.display = 'none';
        }

        // Validações
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePassword(password) {
            return password.length >= 6;
        }

        function validateName(name) {
            return name.trim().length >= 2;
        }

        // ----- EVENTOS -----
        toRegister.onclick = () => {
            showRegister();
            regMsg.innerText = '';
        };

        toLogin.onclick = () => {
            showLogin();
            loginMsg.innerText = '';
        };

        // Cadastro
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage(regMsg);

            try {
                // Aguardar backendStorage estar pronto
                if (!window.backendStorage) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                const storage = window.backendStorage;
                if (!storage) {
                    return; // Sistema não disponível, deixar falhar silenciosamente
                }

                const name = document.getElementById('name').value.trim();
                const email = document.getElementById('email').value.trim().toLowerCase();
                const password = document.getElementById('password').value;
                const confirm = document.getElementById('confirm').value;

                // Validações básicas (deixar HTML5 fazer a maior parte)
                if (!name || !email || !password || !confirm) {
                    return; // Deixar validação HTML5 fazer o trabalho
                }

                // Validações críticas apenas (essenciais para UX)
                if (password !== confirm) {
                    showMessage(regMsg, 'As senhas não coincidem.', 'error');
                    return;
                }

                // Verificar se email já existe (importante para UX)
                if (storage.emailExists(email)) {
                    showMessage(regMsg, 'Este email já está cadastrado.', 'error');
                    return;
                }

                // Criar data de nascimento padrão
                const aniversario = '1990-01-01';

                // Desabilitar botão durante processamento
                const registerSubmit = document.getElementById('register-submit');
                const originalText = registerSubmit.innerHTML;
                registerSubmit.disabled = true;
                registerSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cadastrando...';

                // Registrar usuário
                const newUser = await storage.addUser({
                    nome: name,
                    email: email,
                    senha: password,
                    aniversario: aniversario
                });

                // Fazer login automático após cadastro
                const usuario = storage.authenticateUser(email, password);
                
                if (usuario) {
                    // Armazenar informações do usuário logado
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('loginTime', Date.now());
                    localStorage.setItem('userInfo', JSON.stringify(usuario));
                    
                    if (usuario.session) {
                        localStorage.setItem('currentSession', JSON.stringify(usuario.session));
                    }

                    // Única mensagem: Cadastro aprovado
                    showMessage(regMsg, 'Cadastro aprovado! Redirecionando...', 'success');
                    
                    // Redirecionar para o chat após 1 segundo
                    setTimeout(() => {
                        redirectToChat();
                    }, 1000);
                } else {
                    registerSubmit.disabled = false;
                    registerSubmit.innerHTML = originalText;
                }

            } catch (error) {
                console.error('Erro no cadastro:', error);
                // Reabilitar botão
                const registerSubmit = document.getElementById('register-submit');
                if (registerSubmit) {
                    registerSubmit.disabled = false;
                    registerSubmit.innerHTML = '<i class="fas fa-user-plus"></i> Cadastrar';
                }
                // Mostrar apenas erros críticos
                if (error.message && (error.message.includes('já está cadastrado') || error.message.includes('inválido'))) {
                    showMessage(regMsg, error.message, 'error');
                }
            }
        });

        // Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage(loginMsg);

            try {
                // Aguardar backendStorage estar pronto
                if (!window.backendStorage) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                const storage = window.backendStorage;
                if (!storage) {
                    showMessage(loginMsg, 'Sistema de armazenamento não disponível. Recarregue a página.', 'error');
                    return;
                }

                const email = document.getElementById('login-email').value.trim().toLowerCase();
                const password = document.getElementById('login-password').value;
                const remember = document.getElementById('remember').checked;

                // Validações básicas (apenas verificar se campos não estão vazios)
                if (!email || !password) {
                    return; // Deixar validação HTML5 fazer o trabalho
                }

                // Desabilitar botão durante processamento
                const loginSubmit = document.getElementById('login-submit');
                const originalText = loginSubmit.innerHTML;
                loginSubmit.disabled = true;
                loginSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';

                // Autenticar usuário
                const usuario = storage.authenticateUser(email, password);
                
                if (usuario) {
                    // Armazenar informações do usuário logado
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('loginTime', Date.now());
                    localStorage.setItem('userInfo', JSON.stringify(usuario));
                    
                    if (usuario.session) {
                        localStorage.setItem('currentSession', JSON.stringify(usuario.session));
                    }

                    // Única mensagem: Login aprovado
                    showMessage(loginMsg, 'Login aprovado! Redirecionando...', 'success');
                    
                    // Redirecionar para o chat após 1 segundo
                    setTimeout(() => {
                        redirectToChat();
                    }, 1000);
                } else {
                    // Reabilitar botão em caso de erro
                    loginSubmit.disabled = false;
                    loginSubmit.innerHTML = originalText;
                    // Não mostrar mensagem de erro, apenas limpar campos
                    document.getElementById('login-password').value = '';
                    document.getElementById('login-password').focus();
                }

            } catch (error) {
                console.error('Erro no login:', error);
                // Reabilitar botão em caso de erro
                const loginSubmit = document.getElementById('login-submit');
                if (loginSubmit) {
                    loginSubmit.disabled = false;
                    loginSubmit.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
                }
                // Não mostrar mensagem de erro, apenas log no console
            }
        });

        // Logout
        document.getElementById('logout').addEventListener('click', async () => {
            try {
                // Finalizar sessão no backendStorage se disponível
                const currentSession = localStorage.getItem('currentSession');
                if (currentSession && window.backendStorage) {
                    const session = JSON.parse(currentSession);
                    window.backendStorage.endSession(session.id);
                }
            } catch (error) {
                console.error('Erro ao finalizar sessão:', error);
            }
            
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('loginTime');
            localStorage.removeItem('userInfo');
            localStorage.removeItem('currentSession');
            
            showLogin();
            profileMsg.innerText = 'Você saiu.';
            setTimeout(() => {
                profileMsg.innerText = '';
            }, 3000);
        });

        // Excluir conta
        document.getElementById('delete').addEventListener('click', async () => {
            if (!confirm('Tem certeza que deseja excluir a conta? Isso removerá seus dados permanentemente.')) return;
            
            try {
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || 'null');
                if (!userInfo || !userInfo.id) {
                    alert('Nenhum usuário logado');
                    return;
                }

                if (window.backendStorage) {
                    window.backendStorage.deleteUser(userInfo.id);
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('loginTime');
                    localStorage.removeItem('userInfo');
                    localStorage.removeItem('currentSession');
                    alert('Conta excluída com sucesso.');
                    showLogin();
                } else {
                    alert('Erro: Sistema de armazenamento não disponível');
                }
            } catch (error) {
                console.error('Erro ao excluir conta:', error);
                alert('Erro ao excluir conta: ' + error.message);
            }
        });

        // ----- INICIALIZAÇÃO -----
        async function init() {
            try {
                // Aguardar backendStorage estar pronto
                if (!window.backendStorage) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                // Verificar se usuário já está logado
                const isLoggedIn = localStorage.getItem('isLoggedIn');
                const loginTime = localStorage.getItem('loginTime');
                const userInfo = localStorage.getItem('userInfo');

                if (isLoggedIn === 'true' && loginTime && userInfo) {
                    const currentTime = Date.now();
                    const timeDiff = currentTime - parseInt(loginTime);
                    
                    // Verificar se sessão não expirou (24 horas)
                    if (timeDiff < 24 * 60 * 60 * 1000) {
                        try {
                            const user = JSON.parse(userInfo);
                            profileMsg.innerText = `Usuário já logado. Redirecionando...`;
                            setTimeout(() => {
                                redirectToChat();
                            }, 1000);
                            return;
                        } catch (e) {
                            // Se erro ao parsear, limpar e mostrar login
                        }
                    } else {
                        // Sessão expirada, limpar
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('loginTime');
                        localStorage.removeItem('userInfo');
                        localStorage.removeItem('currentSession');
                    }
                }
                
                showLogin();
            } catch (error) {
                console.error('Erro na inicialização:', error);
                showLogin();
            }
        }

        // Inicializar quando a página carregar
        init();
    </script>
    <script src="../js/header-scroll.js"></script>
</body>
</html> 